<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Builder</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h2 { color: #d4a574; margin: 15px 0 10px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
        h3 { color: #fff; margin: 10px 0; font-size: 14px; }

        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-row > * { flex: 1; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; color: #aaa; font-size: 12px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #333; background: #252525; color: #fff; border-radius: 6px; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #a81612; }
        textarea { resize: vertical; min-height: 60px; }

        .section { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 15px; }

        .option-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .option-btn {
            padding: 10px 16px; background: #2a2a2a; border: 2px solid #3a3a3a;
            border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;
        }
        .option-btn:hover { border-color: #555; background: #333; }
        .option-btn.selected { border-color: #a81612; background: #3a2525; color: #fff; }

        .topping-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; }
        .topping-item {
            display: flex; align-items: center; gap: 8px;
            background: #2a2a2a; padding: 8px 12px; border-radius: 6px;
        }
        .topping-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #a81612; }
        .topping-item label { flex: 1; margin: 0; font-size: 13px; color: #ddd; text-transform: none; cursor: pointer; }
        .topping-item select { width: 80px; padding: 4px; font-size: 11px; }

        .btn {
            background: #a81612; color: #fff; padding: 12px 24px; border: none;
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.2s;
        }
        .btn:hover { background: #c41a15; transform: translateY(-1px); }
        .btn-add { background: #2d7d2d; }
        .btn-add:hover { background: #3a9a3a; }
        .btn-secondary { background: #444; }
        .btn-secondary:hover { background: #555; }
        .btn-small { padding: 6px 12px; font-size: 12px; }

        .orders-list { margin-top: 20px; }
        .order-card {
            background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 8px;
            padding: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px;
        }
        .order-card .order-info { flex: 1; }
        .order-card .order-name { font-weight: 600; color: #d4a574; }
        .order-card .order-details { font-size: 12px; color: #888; margin-top: 4px; }
        .order-card .qty-control { display: flex; align-items: center; gap: 8px; }
        .order-card .qty-control input { width: 50px; text-align: center; padding: 6px; }
        .order-card .btn-remove { background: #6a2020; padding: 6px 10px; }

        #output {
            background: #0d0d0d; padding: 15px; border-radius: 8px; margin-top: 15px;
            font-family: 'Consolas', monospace; font-size: 11px; max-height: 300px;
            overflow-y: auto; white-space: pre-wrap; border: 1px solid #333;
        }

        .actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }

        .divider { height: 1px; background: #333; margin: 15px 0; }

        .extra-toggle { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .extra-toggle input { width: auto; }
        .extra-toggle label { margin: 0; color: #aaa; font-size: 12px; }

        .order-count {
            background: #a81612; color: #fff; padding: 4px 12px; border-radius: 20px;
            font-size: 14px; font-weight: 600;
        }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
            .topping-grid { grid-template-columns: 1fr; }
        }

        /* Group Management Styles */
        .group-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .group-bar select, .group-bar input {
            padding: 8px 12px;
            min-width: 120px;
        }
        .group-bar label {
            margin: 0;
            color: #888;
        }

        .group-section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: #252525;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        .group-header:hover {
            background: #2a2a2a;
        }
        .collapse-icon {
            font-family: monospace;
            width: 16px;
            color: #888;
            transition: transform 0.2s;
        }
        .group-name {
            font-weight: 600;
            color: #d4a574;
            flex: 1;
        }
        .group-rid {
            color: #888;
            font-size: 12px;
        }
        .group-count {
            background: #3a3a3a;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #aaa;
        }
        .group-orders {
            padding: 10px;
        }
        .empty-group {
            color: #555;
            text-align: center;
            padding: 15px;
            font-style: italic;
        }

        .order-card .order-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .btn-edit {
            background: #2d5a7d;
            padding: 6px 10px;
        }
        .btn-edit:hover {
            background: #3a7a9a;
        }
        .move-dropdown {
            padding: 4px 8px;
            font-size: 11px;
            background: #333;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            width: auto;
            min-width: 80px;
        }

        .adding-to-indicator {
            background: #2a3a2a;
            border: 1px solid #3a5a3a;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .adding-to-indicator strong {
            color: #7ac47a;
        }

        .no-groups-prompt {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        .no-groups-prompt p {
            margin-bottom: 15px;
        }

        .edit-mode-indicator {
            background: #3a3a2a;
            border: 1px solid #5a5a3a;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .edit-mode-indicator strong {
            color: #c4c47a;
        }

        .new-group-form {
            background: #1a2a1a;
            border: 1px solid #2a4a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .new-group-form .form-row {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Group Management Section -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Order Groups</h2>
                <button class="btn btn-add btn-small" id="newGroupToggleBtn" onclick="toggleNewGroupForm()">+ New Group</button>
            </div>

            <!-- Inline New Group Form -->
            <div id="newGroupForm" class="new-group-form" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Group Name</label>
                        <input type="text" id="newGroupName" placeholder="e.g. Kevin, Sarah...">
                    </div>
                    <div class="form-group">
                        <label>Restaurant ID</label>
                        <input type="text" id="newGroupRid" placeholder="e.g. 3258">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newGroupEmail" placeholder="e.g. john@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="newGroupPhone" placeholder="e.g. 5551234567">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pickup Date</label>
                        <input type="date" id="newGroupPickupDate">
                    </div>
                    <div class="form-group">
                        <label>Pickup Time</label>
                        <input type="time" id="newGroupPickupTime">
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 8px; padding-bottom: 10px;">
                        <button class="btn btn-add btn-small" onclick="createGroupFromForm()">Create</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleNewGroupForm()">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="group-bar" id="groupBar">
                <div class="form-row" style="margin-bottom: 10px;">
                    <label style="align-self: center;">Active Group:</label>
                    <select id="activeGroupSelect" onchange="selectGroup(this.value)">
                        <option value="">-- Select Group --</option>
                    </select>
                    <label style="align-self: center;">RID:</label>
                    <input type="text" id="activeGroupRid" placeholder="Restaurant ID" onchange="updateActiveGroupField('rid', this.value)">
                    <button class="btn btn-secondary btn-small" onclick="renameActiveGroup()">Rename</button>
                    <button class="btn btn-remove btn-small" onclick="deleteActiveGroup()">Delete</button>
                </div>
                <div class="form-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Email</label>
                        <input type="email" id="activeGroupEmail" placeholder="Email" onchange="updateActiveGroupField('email', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Phone</label>
                        <input type="tel" id="activeGroupPhone" placeholder="Phone" onchange="updateActiveGroupField('phone', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Pickup Date</label>
                        <input type="date" id="activeGroupPickupDate" onchange="updateActiveGroupField('pickupDate', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Pickup Time</label>
                        <input type="time" id="activeGroupPickupTime" onchange="updateActiveGroupField('pickupTime', this.value)">
                    </div>
                </div>
            </div>
            <p id="noGroupsHint" style="color: #666; text-align: center; display: none;">Create a group to start adding orders</p>
        </div>

        <!-- Build Order Section -->
        <div class="section">
            <h2>Build Your Order</h2>

            <div id="addingToIndicator" class="adding-to-indicator" style="display: none;">
                Adding to: <strong id="addingToGroupName">--</strong>
            </div>

            <div id="editModeIndicator" class="edit-mode-indicator" style="display: none;">
                <span>Editing: <strong id="editingOrderName">--</strong></span>
                <button class="btn btn-secondary btn-small" onclick="cancelEdit()">Cancel Edit</button>
            </div>

            <div class="form-group">
                <label>Name for this order</label>
                <input type="text" id="orderName" placeholder="e.g. John, Sarah, etc.">
            </div>

            <div class="divider"></div>

            <h3>Entree Type</h3>
            <div class="option-group" id="entreeOptions">
                <span class="option-btn" data-type="bowl">Bowl</span>
                <span class="option-btn" data-type="burrito">Burrito</span>
                <span class="option-btn" data-type="quesadilla">Quesadilla</span>
            </div>

            <div class="divider"></div>

            <h3>Protein</h3>
            <div class="option-group" id="proteinOptions">
                <span class="option-btn" data-name="Chicken">Chicken</span>
                <span class="option-btn" data-name="Steak">Steak</span>
                <span class="option-btn" data-name="Barbacoa">Barbacoa</span>
                <span class="option-btn" data-name="Carne Asada">Carne Asada</span>
                <span class="option-btn" data-name="Carnitas">Carnitas</span>
                <span class="option-btn" data-name="Sofritas">Sofritas</span>
                <span class="option-btn" data-name="Veggie">Veggie</span>
            </div>
            <div class="extra-toggle">
                <input type="checkbox" id="doubleProtein">
                <label for="doubleProtein">Double Protein (+$)</label>
            </div>

            <div class="divider"></div>

            <h3>Rice</h3>
            <div class="option-group" id="riceOptions">
                <span class="option-btn" data-id="CMG-5001" data-name="White Rice">White</span>
                <span class="option-btn" data-id="CMG-5002" data-name="Brown Rice">Brown</span>
                <span class="option-btn" data-id="CMG-5003" data-name="No Rice">None</span>
            </div>
            <div class="extra-toggle">
                <input type="checkbox" id="extraRice">
                <label for="extraRice">Extra Rice</label>
            </div>

            <div class="divider"></div>

            <h3>Beans</h3>
            <div class="option-group" id="beanOptions">
                <span class="option-btn" data-id="CMG-5051" data-name="Black Beans">Black</span>
                <span class="option-btn" data-id="CMG-5052" data-name="Pinto Beans">Pinto</span>
                <span class="option-btn" data-id="CMG-5053" data-name="No Beans">None</span>
            </div>
            <div class="extra-toggle">
                <input type="checkbox" id="extraBeans">
                <label for="extraBeans">Extra Beans</label>
            </div>

            <div class="divider"></div>

            <h3>Toppings</h3>
            <div class="topping-grid" id="toppings">
                <div class="topping-item">
                    <input type="checkbox" id="top-guac" data-id="CMG-1001" data-name="Guacamole">
                    <label for="top-guac">Guac (+$)</label>
                    <select class="customization"><option value="">Normal</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-queso" data-id="CMG-1029" data-name="Queso Blanco">
                    <label for="top-queso">Queso (+$)</label>
                    <select class="customization"><option value="">Normal</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-fajita" data-id="CMG-5101" data-name="Fajita Veggies">
                    <label for="top-fajita">Fajitas</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-pico" data-id="CMG-5201" data-name="Fresh Tomato Salsa">
                    <label for="top-pico">Pico</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-corn" data-id="CMG-5202" data-name="Roasted Chili-Corn Salsa">
                    <label for="top-corn">Corn</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-green" data-id="CMG-5203" data-name="Tomatillo-Green Chili Salsa">
                    <label for="top-green">Green (Med)</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-red" data-id="CMG-5204" data-name="Tomatillo-Red Chili Salsa">
                    <label for="top-red">Red (Hot)</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-sour" data-id="CMG-5251" data-name="Sour Cream">
                    <label for="top-sour">Sour Cream</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-cheese" data-id="CMG-5252" data-name="Cheese">
                    <label for="top-cheese">Cheese</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
                <div class="topping-item">
                    <input type="checkbox" id="top-lettuce" data-id="CMG-5351" data-name="Romaine Lettuce">
                    <label for="top-lettuce">Lettuce</label>
                    <select class="customization"><option value="">Normal</option><option value="1">Light</option><option value="2">Extra</option><option value="3">Side</option></select>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-add" id="addOrderBtn" onclick="addOrUpdateOrder()">+ Add This Order</button>
            </div>
        </div>

        <!-- Orders List -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Your Orders</h2>
                <span class="order-count" id="orderCount">0 orders</span>
            </div>
            <div class="orders-list" id="ordersList">
                <p style="color: #666; text-align: center; padding: 20px;">No orders yet. Build an order above and click "Add This Order"</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions">
            <button class="btn" onclick="generateJSON()">Generate JSON</button>
            <button class="btn btn-add" onclick="copyJSON()">Copy JSON</button>
            <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
        </div>

        <!-- Output -->
        <div class="section">
            <h2>Generated JSON</h2>
            <div id="output">Add orders and click "Generate JSON" to see output...</div>
        </div>
    </div>

    <script>
        // Group-based order management
        let groups = [];
        let groupIdCounter = 1;
        let orderIdCounter = 1;
        let activeGroupId = null;
        let editingOrder = null; // { orderId, groupId } when editing

        // Menu ID mappings - VERIFIED against rules.js
        const menuIds = {
            bowl: { Chicken: 'CMG-101', Steak: 'CMG-102', Barbacoa: 'CMG-104', 'Carne Asada': 'CMG-108', Carnitas: 'CMG-103', Sofritas: 'CMG-105', Veggie: 'CMG-106' },
            burrito: { Chicken: 'CMG-1', Steak: 'CMG-2', Barbacoa: 'CMG-4', 'Carne Asada': 'CMG-8', Carnitas: 'CMG-3', Sofritas: 'CMG-5', Veggie: 'CMG-6' },
            quesadilla: { Chicken: 'CMG-401', Steak: 'CMG-402', Barbacoa: 'CMG-404', 'Carne Asada': 'CMG-409', Carnitas: 'CMG-403', Sofritas: 'CMG-405' }
        };

        // Extra protein IDs - Note: Veggie has no extra protein option
        const extraProteinIds = { Chicken: 'CMG-1101', Steak: 'CMG-1102', Barbacoa: 'CMG-1104', 'Carne Asada': 'CMG-1107', Carnitas: 'CMG-1103', Sofritas: 'CMG-1106' };

        // Selection state
        let selectedEntree = null;
        let selectedProtein = null;
        let selectedRice = null;
        let selectedBeans = null;

        // =====================
        // GROUP MANAGEMENT
        // =====================

        function toggleNewGroupForm() {
            const form = document.getElementById('newGroupForm');
            const btn = document.getElementById('newGroupToggleBtn');
            const isVisible = form.style.display !== 'none';

            if (isVisible) {
                form.style.display = 'none';
                btn.textContent = '+ New Group';
                // Clear inputs
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupRid').value = '';
                document.getElementById('newGroupEmail').value = '';
                document.getElementById('newGroupPhone').value = '';
                document.getElementById('newGroupPickupDate').value = '';
                document.getElementById('newGroupPickupTime').value = '';
            } else {
                form.style.display = 'block';
                btn.textContent = 'Cancel';
                document.getElementById('newGroupName').focus();
            }
        }

        function createGroupFromForm() {
            const nameInput = document.getElementById('newGroupName');
            const ridInput = document.getElementById('newGroupRid');
            const emailInput = document.getElementById('newGroupEmail');
            const phoneInput = document.getElementById('newGroupPhone');
            const pickupDateInput = document.getElementById('newGroupPickupDate');
            const pickupTimeInput = document.getElementById('newGroupPickupTime');

            const name = nameInput.value.trim();
            const rid = ridInput.value.trim();

            if (!name) {
                nameInput.focus();
                nameInput.style.borderColor = '#a81612';
                return;
            }
            nameInput.style.borderColor = '#333';

            if (!rid) {
                ridInput.focus();
                ridInput.style.borderColor = '#a81612';
                return;
            }
            ridInput.style.borderColor = '#333';

            createGroup(name, rid, {
                email: emailInput.value.trim(),
                phone: phoneInput.value.trim(),
                pickupDate: pickupDateInput.value,
                pickupTime: pickupTimeInput.value
            });
            toggleNewGroupForm();
        }

        function createGroup(name, rid, options = {}) {
            const group = {
                id: groupIdCounter++,
                name: name,
                rid: rid,
                email: options.email || '',
                phone: options.phone || '',
                pickupDate: options.pickupDate || '',
                pickupTime: options.pickupTime || '',
                collapsed: false,
                orders: []
            };
            groups.push(group);
            activeGroupId = group.id;
            updateGroupUI();
            renderGroups();
            return group.id;
        }

        function selectGroup(groupId) {
            groupId = parseInt(groupId);
            if (!groupId) {
                activeGroupId = null;
                updateGroupUI();
                return;
            }
            activeGroupId = groupId;
            updateGroupUI();
        }

        function updateActiveGroupField(field, value) {
            if (!activeGroupId) return;
            const group = groups.find(g => g.id === activeGroupId);
            if (group) {
                group[field] = value;
                renderGroups();
            }
        }

        function renameActiveGroup() {
            if (!activeGroupId) {
                alert('Select a group first');
                return;
            }
            const group = groups.find(g => g.id === activeGroupId);
            if (!group) return;

            // Create inline rename input
            const select = document.getElementById('activeGroupSelect');
            const currentOption = select.options[select.selectedIndex];
            if (!currentOption || !currentOption.value) return;

            const container = select.parentElement;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = group.name;
            input.className = 'rename-input';
            input.style.cssText = 'padding: 8px 12px; min-width: 120px; margin-right: 8px;';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'btn btn-add btn-small';
            saveBtn.style.marginRight = '4px';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'X';
            cancelBtn.className = 'btn btn-secondary btn-small';

            // Hide select, show input
            select.style.display = 'none';
            container.insertBefore(cancelBtn, select.nextSibling);
            container.insertBefore(saveBtn, cancelBtn);
            container.insertBefore(input, saveBtn);
            input.focus();
            input.select();

            const cleanup = () => {
                input.remove();
                saveBtn.remove();
                cancelBtn.remove();
                select.style.display = '';
            };

            const save = () => {
                const newName = input.value.trim();
                if (newName) {
                    group.name = newName;
                    updateGroupUI();
                    renderGroups();
                }
                cleanup();
            };

            saveBtn.onclick = save;
            cancelBtn.onclick = cleanup;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') save();
                if (e.key === 'Escape') cleanup();
            };
        }

        function deleteActiveGroup() {
            if (!activeGroupId) {
                alert('Select a group first');
                return;
            }
            const group = groups.find(g => g.id === activeGroupId);
            if (!group) return;

            if (group.orders.length > 0) {
                if (!confirm(`Delete "${group.name}" and its ${group.orders.length} order(s)?`)) return;
            }

            groups = groups.filter(g => g.id !== activeGroupId);
            activeGroupId = groups.length > 0 ? groups[0].id : null;
            updateGroupUI();
            renderGroups();
        }

        function toggleGroupCollapse(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.collapsed = !group.collapsed;
                renderGroups();
            }
        }

        function updateGroupUI() {
            const select = document.getElementById('activeGroupSelect');
            const ridInput = document.getElementById('activeGroupRid');
            const emailInput = document.getElementById('activeGroupEmail');
            const phoneInput = document.getElementById('activeGroupPhone');
            const pickupDateInput = document.getElementById('activeGroupPickupDate');
            const pickupTimeInput = document.getElementById('activeGroupPickupTime');
            const groupBar = document.getElementById('groupBar');
            const noGroupsHint = document.getElementById('noGroupsHint');
            const addingToIndicator = document.getElementById('addingToIndicator');
            const addingToGroupName = document.getElementById('addingToGroupName');

            // Populate dropdown
            select.innerHTML = '<option value="">-- Select Group --</option>' +
                groups.map(g => `<option value="${g.id}" ${g.id === activeGroupId ? 'selected' : ''}>${g.name}</option>`).join('');

            // Show/hide UI based on groups existence
            if (groups.length === 0) {
                groupBar.style.display = 'none';
                noGroupsHint.style.display = 'block';
                addingToIndicator.style.display = 'none';
            } else {
                groupBar.style.display = 'block';
                noGroupsHint.style.display = 'none';

                if (activeGroupId) {
                    const group = groups.find(g => g.id === activeGroupId);
                    if (group) {
                        ridInput.value = group.rid || '';
                        emailInput.value = group.email || '';
                        phoneInput.value = group.phone || '';
                        pickupDateInput.value = group.pickupDate || '';
                        pickupTimeInput.value = group.pickupTime || '';
                        addingToIndicator.style.display = 'block';
                        addingToGroupName.textContent = group.name;
                    }
                } else {
                    ridInput.value = '';
                    emailInput.value = '';
                    phoneInput.value = '';
                    pickupDateInput.value = '';
                    pickupTimeInput.value = '';
                    addingToIndicator.style.display = 'none';
                }
            }
        }

        function getGroupOrderCount(group) {
            return group.orders.reduce((sum, o) => sum + o.qty, 0);
        }

        // Option click handlers
        function setupOptionGroup(containerId, callback) {
            document.querySelectorAll(`#${containerId} .option-btn`).forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll(`#${containerId} .option-btn`).forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    callback(el);
                });
            });
        }

        setupOptionGroup('entreeOptions', el => selectedEntree = el.dataset.type);
        setupOptionGroup('proteinOptions', el => selectedProtein = el.dataset.name);
        setupOptionGroup('riceOptions', el => selectedRice = { id: el.dataset.id, name: el.dataset.name });
        setupOptionGroup('beanOptions', el => selectedBeans = { id: el.dataset.id, name: el.dataset.name });

        function buildContents() {
            const contents = [];

            // Double protein (not available for Veggie)
            if (document.getElementById('doubleProtein').checked && selectedProtein && extraProteinIds[selectedProtein]) {
                const extraName = selectedProtein === 'Barbacoa' ? 'Extra Beef Barbacoa' : `Extra ${selectedProtein}`;
                contents.push({
                    menuItemId: extraProteinIds[selectedProtein],
                    menuItemName: extraName,
                    quantity: 1, isUpSell: false, customizationId: null
                });
            }

            // Rice (always add, including "No Rice" CMG-5003)
            if (selectedRice) {
                contents.push({
                    menuItemId: selectedRice.id,
                    menuItemName: selectedRice.name,
                    quantity: 1, isUpSell: false,
                    customizationId: (selectedRice.id !== 'CMG-5003' && document.getElementById('extraRice').checked) ? 2 : null
                });
            }

            // Beans (don't apply Extra to "No Beans")
            if (selectedBeans) {
                contents.push({
                    menuItemId: selectedBeans.id,
                    menuItemName: selectedBeans.name,
                    quantity: 1, isUpSell: false,
                    customizationId: (selectedBeans.id !== 'CMG-5053' && document.getElementById('extraBeans').checked) ? 2 : null
                });
            }

            // Toppings
            document.querySelectorAll('#toppings .topping-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    const select = item.querySelector('select');
                    let itemId = checkbox.dataset.id;
                    let customization = select.value ? parseInt(select.value) : null;

                    // Queso Blanco: use CMG-4134 for Quesadilla (Addon type, no customization)
                    if (checkbox.id === 'top-queso' && selectedEntree === 'quesadilla') {
                        itemId = 'CMG-4134';
                        customization = null;
                    }

                    contents.push({
                        menuItemId: itemId,
                        menuItemName: checkbox.dataset.name,
                        quantity: 1, isUpSell: false,
                        customizationId: customization
                    });
                }
            });

            return contents;
        }

        function addOrUpdateOrder() {
            if (editingOrder) {
                updateOrder();
            } else {
                addOrder();
            }
        }

        function addOrder() {
            if (!activeGroupId) {
                alert('Please create a group first');
                return;
            }

            if (!selectedEntree || !selectedProtein || !selectedRice || !selectedBeans) {
                alert('Please select entree type, protein, rice, and beans');
                return;
            }

            // Veggie Quesadilla doesn't exist
            if (selectedEntree === 'quesadilla' && selectedProtein === 'Veggie') {
                alert('Veggie Quesadilla is not available. Please choose Bowl or Burrito for Veggie.');
                return;
            }

            // Warn if trying to double Veggie (not available)
            if (selectedProtein === 'Veggie' && document.getElementById('doubleProtein').checked) {
                alert('Double Protein is not available for Veggie. The order will be added without double protein.');
                document.getElementById('doubleProtein').checked = false;
            }

            const orderName = document.getElementById('orderName').value.trim() || 'Customer';
            const proteinName = selectedProtein === 'Barbacoa' ? 'Beef Barbacoa' : selectedProtein;
            const entreeName = `${proteinName} ${selectedEntree.charAt(0).toUpperCase() + selectedEntree.slice(1)}`;
            const order = {
                id: orderIdCounter++,
                qty: 1,
                orderName: orderName,
                entreeType: selectedEntree,
                protein: selectedProtein,
                entreeName: entreeName,
                menuItemId: menuIds[selectedEntree][selectedProtein],
                contents: buildContents(),
                doubleProtein: document.getElementById('doubleProtein').checked,
                description: buildDescription()
            };

            const group = groups.find(g => g.id === activeGroupId);
            if (group) {
                group.orders.push(order);
            }
            renderGroups();
            resetOrderForm();
        }

        // =====================
        // EDIT ORDER
        // =====================

        function editOrder(orderId, groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            const order = group.orders.find(o => o.id === orderId);
            if (!order) return;

            // Expand group if collapsed
            if (group.collapsed) {
                group.collapsed = false;
                renderGroups();
            }

            // Set editing state
            editingOrder = { orderId, groupId };

            // Populate form with order data
            document.getElementById('orderName').value = order.orderName;

            // Select entree type
            document.querySelectorAll('#entreeOptions .option-btn').forEach(el => {
                el.classList.toggle('selected', el.dataset.type === order.entreeType);
            });
            selectedEntree = order.entreeType;

            // Select protein
            document.querySelectorAll('#proteinOptions .option-btn').forEach(el => {
                el.classList.toggle('selected', el.dataset.name === order.protein);
            });
            selectedProtein = order.protein;

            // Set double protein
            document.getElementById('doubleProtein').checked = order.doubleProtein;

            // Find rice and beans from contents
            const riceItem = order.contents.find(c => ['CMG-5001', 'CMG-5002', 'CMG-5003'].includes(c.menuItemId));
            const beansItem = order.contents.find(c => ['CMG-5051', 'CMG-5052', 'CMG-5053'].includes(c.menuItemId));

            // Select rice
            if (riceItem) {
                document.querySelectorAll('#riceOptions .option-btn').forEach(el => {
                    const isSelected = el.dataset.id === riceItem.menuItemId;
                    el.classList.toggle('selected', isSelected);
                    if (isSelected) selectedRice = { id: el.dataset.id, name: el.dataset.name };
                });
                document.getElementById('extraRice').checked = riceItem.customizationId === 2;
            }

            // Select beans
            if (beansItem) {
                document.querySelectorAll('#beanOptions .option-btn').forEach(el => {
                    const isSelected = el.dataset.id === beansItem.menuItemId;
                    el.classList.toggle('selected', isSelected);
                    if (isSelected) selectedBeans = { id: el.dataset.id, name: el.dataset.name };
                });
                document.getElementById('extraBeans').checked = beansItem.customizationId === 2;
            }

            // Set toppings
            document.querySelectorAll('#toppings .topping-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const select = item.querySelector('select');
                const toppingId = checkbox.dataset.id;

                // Check if this topping is in the order (handle queso special case)
                const contentItem = order.contents.find(c =>
                    c.menuItemId === toppingId ||
                    (checkbox.id === 'top-queso' && c.menuItemId === 'CMG-4134')
                );

                checkbox.checked = !!contentItem;
                if (contentItem && contentItem.customizationId) {
                    select.value = contentItem.customizationId.toString();
                } else {
                    select.value = '';
                }
            });

            // Update UI
            document.getElementById('editModeIndicator').style.display = 'flex';
            document.getElementById('editingOrderName').textContent = `${order.orderName}: ${order.entreeName}`;
            document.getElementById('addOrderBtn').textContent = 'Update Order';

            // Scroll to form
            document.getElementById('orderName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function updateOrder() {
            if (!editingOrder) return;

            if (!selectedEntree || !selectedProtein || !selectedRice || !selectedBeans) {
                alert('Please select entree type, protein, rice, and beans');
                return;
            }

            if (selectedEntree === 'quesadilla' && selectedProtein === 'Veggie') {
                alert('Veggie Quesadilla is not available.');
                return;
            }

            if (selectedProtein === 'Veggie' && document.getElementById('doubleProtein').checked) {
                document.getElementById('doubleProtein').checked = false;
            }

            const group = groups.find(g => g.id === editingOrder.groupId);
            if (!group) return;
            const order = group.orders.find(o => o.id === editingOrder.orderId);
            if (!order) return;

            // Update order
            order.orderName = document.getElementById('orderName').value.trim() || 'Customer';
            order.entreeType = selectedEntree;
            order.protein = selectedProtein;
            const proteinName = selectedProtein === 'Barbacoa' ? 'Beef Barbacoa' : selectedProtein;
            order.entreeName = `${proteinName} ${selectedEntree.charAt(0).toUpperCase() + selectedEntree.slice(1)}`;
            order.menuItemId = menuIds[selectedEntree][selectedProtein];
            order.contents = buildContents();
            order.doubleProtein = document.getElementById('doubleProtein').checked;
            order.description = buildDescription();

            cancelEdit();
            renderGroups();
        }

        function cancelEdit() {
            editingOrder = null;
            document.getElementById('editModeIndicator').style.display = 'none';
            document.getElementById('addOrderBtn').textContent = '+ Add This Order';
            resetOrderForm();
        }

        // =====================
        // MOVE ORDER
        // =====================

        function moveOrderToGroup(orderId, fromGroupId, toGroupId) {
            fromGroupId = parseInt(fromGroupId);
            toGroupId = parseInt(toGroupId);
            if (fromGroupId === toGroupId) return;

            const fromGroup = groups.find(g => g.id === fromGroupId);
            const toGroup = groups.find(g => g.id === toGroupId);
            if (!fromGroup || !toGroup) return;

            const orderIndex = fromGroup.orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;

            const [order] = fromGroup.orders.splice(orderIndex, 1);
            toGroup.orders.push(order);

            renderGroups();
        }

        function buildDescription() {
            let parts = [];
            const displayProtein = selectedProtein === 'Barbacoa' ? 'Beef Barbacoa' : selectedProtein;
            if (document.getElementById('doubleProtein').checked) parts.push('Double ' + displayProtein);
            else parts.push(displayProtein);

            if (selectedRice && selectedRice.id !== 'CMG-5003') {
                let r = selectedRice.name.replace(' Rice', '');
                if (document.getElementById('extraRice').checked) r = 'Extra ' + r;
                parts.push(r);
            }

            if (selectedBeans && selectedBeans.id !== 'CMG-5053') {
                let b = selectedBeans.name.replace(' Beans', '');
                if (document.getElementById('extraBeans').checked) b = 'Extra ' + b;
                parts.push(b);
            }

            document.querySelectorAll('#toppings .topping-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    const label = item.querySelector('label').textContent;
                    const select = item.querySelector('select');
                    let mod = '';
                    if (select.value === '1') mod = 'Light ';
                    if (select.value === '2') mod = 'Extra ';
                    if (select.value === '3') mod = label + ' (Side)';
                    else mod = mod + label;
                    parts.push(mod);
                }
            });

            return parts.join(', ');
        }

        function renderGroups() {
            const container = document.getElementById('ordersList');
            const countEl = document.getElementById('orderCount');

            // Calculate total across all groups
            const totalQty = groups.reduce((sum, g) =>
                sum + g.orders.reduce((oSum, o) => oSum + o.qty, 0), 0);
            countEl.textContent = `${totalQty} order${totalQty !== 1 ? 's' : ''}`;

            if (groups.length === 0) {
                container.innerHTML = '<div class="no-groups-prompt"><p>No groups yet.</p><p>Create a group above to start adding orders.</p></div>';
                return;
            }

            container.innerHTML = groups.map(group => {
                const pickupStr = (group.pickupDate && group.pickupTime)
                    ? `${group.pickupDate} ${group.pickupTime}`
                    : '(no pickup time)';
                return `
                <div class="group-section" data-group-id="${group.id}">
                    <div class="group-header" onclick="toggleGroupCollapse(${group.id})">
                        <span class="collapse-icon">${group.collapsed ? '▶' : '▼'}</span>
                        <span class="group-name">${group.name}</span>
                        <span class="group-rid">RID: ${group.rid || '(not set)'}</span>
                        <span class="group-rid">${pickupStr}</span>
                        <span class="group-count">${getGroupOrderCount(group)} order${getGroupOrderCount(group) !== 1 ? 's' : ''}</span>
                    </div>
                    ${!group.collapsed ? `
                        <div class="group-orders">
                            ${group.orders.length === 0
                                ? '<p class="empty-group">No orders in this group yet</p>'
                                : group.orders.map(order => renderOrderCard(order, group.id)).join('')
                            }
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        function renderOrderCard(order, groupId) {
            const otherGroups = groups.filter(g => g.id !== groupId);
            const moveOptions = otherGroups.length > 0
                ? `<select class="move-dropdown" onchange="moveOrderToGroup(${order.id}, ${groupId}, this.value); this.value=''">
                    <option value="">Move to...</option>
                    ${otherGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
                   </select>`
                : '';

            return `
                <div class="order-card">
                    <div class="order-info">
                        <div class="order-name">${order.orderName}: ${order.entreeName}</div>
                        <div class="order-details">${order.description}</div>
                    </div>
                    <div class="qty-control">
                        <label style="font-size: 12px; color: #888;">Qty:</label>
                        <input type="number" min="1" value="${order.qty}" onchange="updateQty(${order.id}, ${groupId}, this.value)">
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-edit btn-small" onclick="editOrder(${order.id}, ${groupId})">Edit</button>
                        ${moveOptions}
                        <button class="btn btn-remove btn-small" onclick="removeOrder(${order.id}, ${groupId})">X</button>
                    </div>
                </div>
            `;
        }

        function updateQty(orderId, groupId, qty) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                const order = group.orders.find(o => o.id === orderId);
                if (order) order.qty = Math.max(1, parseInt(qty) || 1);
            }
            renderGroups();
        }

        function removeOrder(orderId, groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.orders = group.orders.filter(o => o.id !== orderId);
            }
            renderGroups();
        }

        function resetOrderForm() {
            document.querySelectorAll('#entreeOptions .option-btn, #proteinOptions .option-btn').forEach(el => el.classList.remove('selected'));
            document.getElementById('orderName').value = '';
            document.getElementById('doubleProtein').checked = false;
            document.getElementById('extraRice').checked = false;
            document.getElementById('extraBeans').checked = false;
            document.querySelectorAll('#toppings input[type="checkbox"]').forEach(el => el.checked = false);
            document.querySelectorAll('#toppings select').forEach(el => el.value = '');
            selectedEntree = null;
            selectedProtein = null;
            // Keep rice and beans selected for convenience
        }

        function generateJSON() {
            // Collect all orders from all groups with group info
            const allOrders = [];
            let missingRid = false;
            let missingInfo = [];

            groups.forEach(group => {
                if (!group.rid) missingRid = true;
                if (!group.email) missingInfo.push(`${group.name}: missing email`);
                if (!group.phone) missingInfo.push(`${group.name}: missing phone`);
                if (!group.pickupDate || !group.pickupTime) missingInfo.push(`${group.name}: missing pickup date/time`);

                group.orders.forEach(order => {
                    allOrders.push({
                        ...order,
                        groupRid: group.rid,
                        groupName: group.name,
                        groupEmail: group.email,
                        groupPhone: group.phone,
                        groupPickupDate: group.pickupDate,
                        groupPickupTime: group.pickupTime
                    });
                });
            });

            if (allOrders.length === 0) {
                alert('Add some orders first!');
                return;
            }

            if (missingRid) {
                alert('Some groups are missing Restaurant ID. Please set RID for all groups.');
                return;
            }

            if (missingInfo.length > 0) {
                alert('Missing info:\n' + missingInfo.join('\n'));
                return;
            }

            const profiles = [];
            let profileNum = 1;

            allOrders.forEach(order => {
                const pickupDateTime = (order.groupPickupDate && order.groupPickupTime)
                    ? `${order.groupPickupDate}T${order.groupPickupTime}:00`
                    : '';
                const phone = order.groupPhone.replace(/\D/g, '');

                for (let i = 0; i < order.qty; i++) {
                    const orderFirstName = order.orderName;
                    const profileName = `${orderFirstName} ${profileNum}`;
                    profiles.push({
                        name: profileName,
                        taskCount: 1,
                        restaurantId: order.groupRid,
                        promoCode: "",
                        pickupDateTime: pickupDateTime,
                        bagPickupLocationId: 1,
                        tipAmount: 0,
                        firstName: orderFirstName,
                        email: order.groupEmail,
                        phoneNumber: phone,
                        meal: {
                            mealName: orderFirstName,
                            entrees: [{
                                menuItemId: order.menuItemId,
                                menuItemName: order.entreeName,
                                quantity: 1,
                                contents: order.contents
                            }],
                            sides: [],
                            drinks: []
                        }
                    });
                    profileNum++;
                }
            });

            const output = { profiles };
            document.getElementById('output').textContent = JSON.stringify(output, null, 2);
        }

        function copyJSON() {
            const text = document.getElementById('output').textContent;
            if (text.includes('Add orders')) {
                alert('Generate JSON first!');
                return;
            }
            navigator.clipboard.writeText(text).then(() => alert('Copied!'));
        }

        function clearAll() {
            const totalOrders = groups.reduce((sum, g) => sum + g.orders.length, 0);
            if (totalOrders > 0 && !confirm('Clear all groups and orders?')) return;
            groups = [];
            groupIdCounter = 1;
            orderIdCounter = 1;
            activeGroupId = null;
            editingOrder = null;
            cancelEdit();
            updateGroupUI();
            renderGroups();
            document.getElementById('output').textContent = 'Add orders and click "Generate JSON" to see output...';
        }

        // Initialize UI
        updateGroupUI();
        renderGroups();
    </script>
</body>
</html>
